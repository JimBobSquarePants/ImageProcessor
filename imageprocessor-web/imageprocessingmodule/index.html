---
permalink: imageprocessor-web/imageprocessingmodule/

layout: class
class: ImageProcessingModule
methodof: null
title: ImageProcessingModule
heading: ImageProcessingModule
subheading: Intercepts and processes image requests.
sublinks:
 - "#about|About"
 - "#remote|Remote Files"
 - "#caching|Caching"
 - "#events|Events"
---
<section id="about">
    <h1>ImageProcessingModule</h1>
    <p>
        The ImageProcessingModule class provides methods to perform various manipulation functions on a given image based on querystring parameters.
        The HttpModule is asynchronous and optimized for performance so that your website does not slow down under heavy load.
    </p>
    <div class="alert" role="alert">
        <p>
            The API for ImageProcessor.Web is imperative. This means that the order in which you supply the querystring parameters is the order in which the
            individual processors are implemented. This allows the API to be very flexible, allowing you to combine processes in any order.
        </p>
    </div>
</section>
<hr />
<section id="remote">
    <h1>Remote Files</h1>
    <p>
        <strong>ImageProcessor.Web</strong> allows you to configure remote image requests from a whitelist of urls.
        These commands are set in the <a href="../configuration/#securityconfig" rel="chapter">security.config<i class="fa fa-file-text-o"></i></a> file under the 
        path <code>\config\imageprocessor\</code> within your solution. The more precise the url, the more restrictive the whitelist.
    </p>
    <p>
        Remote requests are given in the following format:
    </p>
    {% highlight xml %}
<!-- Recommended syntax as of version 4.2 Note the lack of protocol -->
/remote.axd/your-external-image?width=300

<!-- Legacy syntax -->
/remote.axd?http://your-external-image?width=300
    {% endhighlight %}
</section>
<hr />
<section id="caching">
    <h1>Caching</h1>
    <p>
        <strong>ImageProcessor.Web</strong> comes with caching as standard. Any processed image are asynchronously cached both in the browser and on the server
        for a length of your choosing. The server cache intelligently stores millions of images and silently updates itself should the original image change or
        the cache expire.
    </p>
    <p>
        Cached files, by default, are stored in nested folders based on an <abbr title="Secure Hash Algorithm">SHA-1</abbr> representation of the full url with a small number of images in each folder.
        This allows for the storage of millions of images whilst ensuring that the OS does not suffer from any slowdown due to file indexing.
    </p>
    <p>
        The caching mechanism saves massive amounts of processing power and bandwidth that help to keep your website snappy.
    </p>
    <div class="alert" role="alert">
        <p>
            As of version <a href="https://www.nuget.org/packages/ImageProcessor.Web/4.2.0">4.2.0</a> this caching mechanism is plugin based. See the
            <a href="../extending/" rel="chapter">extending<i class="fa fa-file-text-o"></i></a> documentaion for details.
        </p>
    </div>
</section>
<hr />
<section id="events">
    <h1>Events</h1>
    <h3>ImageProcessingModule.ValidatingRequest</h3>
    <p>
        On initial examination of an image request the ImageProcessingModule will raise an
        <code>ValidatingRequest</code> event. This allows the developer to add their own instructions to
        the ImageProcessingModule without requiring them to be present in the request URL. This is useful
        for adding extra security measures to image requests or for changing the background colour of image formats that do not
        support alpha transparency.
    </p>
    <p>
        This event passes the following parameters:
    </p>
    <dl>
        <dt><strong>sender</strong></dt>
        <dd>
            The instance of <code>ImageProcessingModule</code> raising the event.
        </dd>
        <dt><strong>eventargs</strong></dt>
        <dd>
            The <code>ValidatingRequestEventArgs</code> containing the following information.
            <dl>
                <dt><strong>Context</strong></dt>
                <dd>The current <code>HttpContext</code>.</dd>
            </dl>
            <dl>
                <dt><strong>Querystring </strong></dt>
                <dd>The querystring part of the current request.</dd>
            </dl>
        </dd>
    </dl>
    <h3>Example Code</h3>
    {% highlight c# %}
ImageProcessingModule.ValidatingRequest += (sender, args) =>
{
    if (!string.IsNullOrWhiteSpace(args.QueryString))
    {
        // Don't support alpha whatsoever
        var queryCollection = HttpUtility.ParseQueryString(args.QueryString);
        if (queryCollection.AllKeys.Contains("alpha"))
        {
            args.Cancel = true;
            return;
        }

        // If there's a crop parameter, force it to always just be a specific value
        if (queryCollection.AllKeys.Contains("crop"))
        {
            queryCollection["crop"] = "10,10,10,10";
            
            // This performs the reverse of ParseQueryString since the result of ParseQueryString
            // is actually an instance of System.Web.HttpValueCollection
            args.QueryString = queryCollection.ToString();
        }
    }
};
    {% endhighlight %}

    <hr />
    
    <h3>ImageProcessingModule.OnProcessQuerystring</h3>
    <div class="alert" role="alert">
        <p>
            As of version <a href="https://www.nuget.org/packages/ImageProcessor.Web/4.6.0">4.6.0</a> this event has been marked obsolete.
            Use <code>ImageProcessingModule.ValidatingRequest instead</code>.
        </p>
    </div>
    <p>
        On initial examination of an image request the ImageProcessingModule will raise an
        <code>OnProcessQuerystring</code> event. This allows the developer to add their own instructions to
        the ImageProcessingModule without requiring them to be present in the request URL. This is useful
        for adding security watermarks to images or for changing the background colour of image formats that do not
        support alpha transparency.
    </p>
    <p>
        This event passes the following parameters:
    </p>
    <dl>
        <dt><strong>sender</strong></dt>
        <dd>
            The instance of <code>ImageProcessingModule</code> raising the event.
        </dd>
        <dt><strong>eventargs</strong></dt>
        <dd>
            The <code>ProcessQuerystringEventArgs</code> containing the following information.
            <dl>
                <dt><strong>RawUrl </strong></dt>
                <dd>The raw URL of the current request.</dd>
            </dl>
            <dl>
                <dt><strong>Querystring </strong></dt>
                <dd>The querystring part of the current request.</dd>
            </dl>
        </dd>
    </dl>
    <h3>Example Code</h3>
    {% highlight c# %}
ImageProcessingModule.OnProcessQuerystring += (sender, args) =>
{
    if (!args.RawUrl.Contains("watermark"))
    {
        return args.Querystring += "watermark=protected&color=fff&fontsize=36&fontopacity=70textshadow=true&fontfamily=arial";
    }

    return args.Querystring;
};
    {% endhighlight %}

    <hr />

    <h3>ImageProcessingModule.OnPostProcessing</h3>
    <p>
        On processing of a new or updated, uncached image the ImageProcessingModule will raise an awaitable
        <code>OnPostProcessing</code> event.
    </p>
    <p>
        This passes the following parameters:
    </p>
    <dl>
        <dt><strong>sender</strong></dt>
        <dd>
            The instance of <code>ImageProcessingModule</code> raising the event.
        </dd>
        <dt><strong>eventargs</strong></dt>
        <dd>
            The <code>PostProcessingEventArgs</code> containing the following information.
            <dl>
                <dt><strong>CachedImagePath </strong></dt>
                <dd>The absolute path to the newly cached image.</dd>
            </dl>
        </dd>
    </dl>
    <h3>Example Code</h3>
    {% highlight c# %}
// Synchronous example.
ImageProcessingModule.OnPostProcessing += (sender, args) => Debug.WriteLine(args.CachedImagePath);

// Asynchronous example
ImageProcessingModule.OnPostProcessing += this.WritePath;
private async void WritePath(object sender, PostProcessingEventArgs e)
{
    // This is just for demo purposes. You would not normally use Task.Run in ASP.NET
    await Task.Run(() => Debug.WriteLine(e.CachedImagePath));
}
    {% endhighlight %}
</section>
